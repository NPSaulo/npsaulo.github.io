(function(e) {
    function u(s, o) {
        var u, a, f;
        if ((u = e(s)).length == 0) return null;
        a = u.offset().top;
        
        // Calculate target scroll position without adding offset.
        switch (o.anchor) {
            case "middle":
                f = a - (e(window).height() - u.outerHeight()) / 2;
                break;
            default:
            case "top":
                f = Math.max(a, 0);
        }
        
        return f;
    }

    var s = "click.scrolly", o = e(window);

    e.fn.scrolly = function(i) {
        var o, a, f, l, c = e(this);
        if (this.length == 0) return c;
        if (this.length > 1) {
            for (o = 0; o < this.length; o++) e(this[o]).scrolly(i);
            return c;
        }

        l = null, f = c.attr("href");
        if (f.charAt(0) != "#" || f.length < 2) return c;
        
        a = jQuery.extend({
            anchor: "top",
            easing: "swing",
            parent: e("body,html"),
            pollOnce: false,
            speed: 1000
        }, i);
        
        // Pre-calculate scroll position if pollOnce is true.
        if (a.pollOnce) l = u(f, a);
        
        // Set up click event.
        c.off(s).on(s, function(e) {
            var t = l !== null ? l : u(f, a);
            if (t !== null) {
                e.preventDefault();
                a.parent.stop().animate({ scrollTop: t }, a.speed, a.easing);
            }
        });
    };
})(jQuery);
